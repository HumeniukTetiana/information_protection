<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤—ñ—Å –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—ó (RSA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .btn-primary {
            background-color: #0d1a33;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1a2b4b;
        }
        .btn-secondary {
            background-color: #f0f4f8;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            border: 1px solid #d1d5db;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e2e8f0;
        }
        .card-title {
            color: #1e40af;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .key-output {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .result-box {
            background-color: #f0fdf4; /* Light green for results */
            border-left: 4px solid #10b981; /* Green border */
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

<header class="bg-indigo-900 shadow-lg text-white py-4 mb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-xl font-bold text-center tracking-wider">–°–µ—Ä–≤—ñ—Å –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—ó (RSA)</h1>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4">

    {% if message or error %}
    <div class="mb-6 p-4 rounded-lg text-sm {% if error %}bg-red-100 text-red-800 border border-red-300{% else %}bg-green-100 text-green-800 border border-green-300{% endif %}" role="alert">
        {{ message | default:error }}
    </div>
    {% endif %}

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">1. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è RSA –ö–ª—é—á—ñ–≤</h2>
        <form method="post" action="." class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="generate_keys">
            <p class="text-gray-600">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É –ø–∞—Ä—É –ø—É–±–ª—ñ—á–Ω–æ–≥–æ —Ç–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á—ñ–≤.</p>
            <button type="submit" class="btn-primary">
                –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∫–ª—é—á—ñ
            </button>
        </form>

        {% if private_key and public_key %}
        <div class="mt-6 space-y-4">
            <div>
                <label class="block text-gray-700 font-medium mb-1">–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á (Private Key):</label>
                <div class="key-output h-32 overflow-auto">{{ private_key }}</div>
                <a href="#" id="download-private" class="btn-secondary mt-2 inline-block text-sm" download="private_key.pem">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Private Key</a>
            </div>
            <div>
                <label class="block text-gray-700 font-medium mb-1">–ü—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á (Public Key):</label>
                <div class="key-output h-32 overflow-auto">{{ public_key }}</div>
                <a href="#" id="download-public" class="btn-secondary mt-2 inline-block text-sm" download="public_key.pem">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Public Key</a>
            </div>
        </div>
        {% endif %}

    </section>

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">2. –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –§–∞–π–ª—É RSA</h2>

        <form method="post" action="." enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="encrypt_rsa">
            <p class="text-gray-600">–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ–∞–π–ª –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ (.pem). –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.</p>

            <div>
                <label class="block text-gray-700 font-medium mb-1">–§–∞–π–ª –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è:</label>
                <input type="file" name="data_file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">–§–∞–π–ª –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ (.pem):</label>
                <input type="file" name="public_key_file" accept=".pem" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" required>
            </div>

            <button type="submit" class="btn-primary">
                –ó–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —Ñ–∞–π–ª (RSA)
            </button>
        </form>

        {% if encrypted_data_base64 and cipher_type == "RSA" %}
        <div class="result-box">
            <h3 class="font-bold text-lg text-gray-800 mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è RSA:</h3>
            <p><strong>–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> <span class="text-blue-600">{{ enc_time }} —Å–µ–∫.</span></p>
            <button onclick="downloadFile('{{ encrypted_data_base64 }}', '{{ encrypted_filename }}')"
                    class="btn-primary mt-4 w-full bg-green-700 hover:bg-green-800 transition duration-200">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –§–∞–π–ª ({{ encrypted_filename }})
            </button>
        </div>
        {% endif %}
    </section>

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">3. –†–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –§–∞–π–ª—É RSA</h2>

        <form method="post" action="." enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="decrypt_rsa">

            <p class="text-gray-600">–í–∏–±–µ—Ä—ñ—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª (.rsa) —Ç–∞ **–ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á** (.pem) –¥–ª—è –π–æ–≥–æ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è.</p>

            <div>
                <label class="block text-gray-700 font-medium mb-1">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª (.rsa):</label>
                <input type="file" name="encrypted_file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">–§–∞–π–ª –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (.pem):</label>
                <input type="file" name="private_key_file" accept=".pem" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" required>
            </div>

            <button type="submit" class="btn-primary">
                –†–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —Ñ–∞–π–ª (RSA)
            </button>
        </form>

        {% if decrypted_data_base64 and cipher_type == "RSA" %}
        <div class="result-box">
            <h3 class="font-bold text-lg text-gray-800 mb-2">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è RSA:</h3>
            <button onclick="downloadFile('{{ decrypted_data_base64 }}', '{{ decrypted_filename }}')"
                    class="btn-primary mt-4 w-full bg-red-700 hover:bg-red-800 transition duration-200">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –†–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –§–∞–π–ª ({{ decrypted_filename }})
            </button>
        </div>
        {% endif %}
    </section>

</main>

<script>
    /**
     * –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∑ Base64 —Ä—è–¥–∫–∞.
     * @param {string} base64Data - Base64 –∑–∞–∫–æ–¥–æ–≤–∞–Ω—ñ –±—ñ–Ω–∞—Ä–Ω—ñ –¥–∞–Ω—ñ.
     * @param {string} filename - –Ü–º'—è —Ñ–∞–π–ª—É –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
     */
    function downloadFile(base64Data, filename) {
        if (!base64Data || !filename) {
            console.error("Missing data or filename for download.");
            return;
        }
        try {
            // 1. –î–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è Base64 —É –±—ñ–Ω–∞—Ä–Ω–∏–π —Ä—è–¥–æ–∫
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);

            // 2. –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –Ω–∞ –º–∞—Å–∏–≤ –±–∞–π—Ç—ñ–≤
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Blob (–¥–≤—ñ–π–∫–æ–≤–æ–≥–æ –æ–±'—î–∫—Ç–∞)
            const blob = new Blob([bytes], { type: 'application/octet-stream' });

            // 4. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;

            // 5. –ó–∞–ø—É—Å–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // –ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞
        } catch (e) {
            alert(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É: ${e.message}. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ Base64 –¥–∞–Ω—ñ.`);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const privateKeyLink = document.getElementById('download-private');
        const publicKeyLink = document.getElementById('download-public');

        if (privateKeyLink && publicKeyLink) {
            // –û—Ç—Ä–∏–º—É—î–º–æ –≤–º—ñ—Å—Ç –∫–ª—é—á–∞ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ div.key-output
            const privateContent = privateKeyLink.previousElementSibling.innerText;
            const publicContent = publicKeyLink.previousElementSibling.innerText;

            function createDownloadLink(element, content) {
                const blob = new Blob([content], { type: 'application/x-pem-file' });
                const url = URL.createObjectURL(blob);
                element.href = url;
            }

            // –ü—Ä–∏–≤'—è–∑–∫–∞ –¥–æ –ø–æ—Å–∏–ª–∞–Ω—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—é—á—ñ–≤ (—è–∫—â–æ –≤–æ–Ω–∏ –±—É–ª–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ)
            createDownloadLink(privateKeyLink, privateContent);
            createDownloadLink(publicKeyLink, publicContent);
        }
    });
</script>

</body>
</html>