<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сервіс Криптографії (RSA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .btn-primary {
            background-color: #0d1a33;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1a2b4b;
        }
        .btn-secondary {
            background-color: #f0f4f8;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            border: 1px solid #d1d5db;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e2e8f0;
        }
        .card-title {
            color: #1e40af;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .key-output {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .result-box {
            background-color: #f0fdf4; /* Light green for results */
            border-left: 4px solid #10b981; /* Green border */
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

<header class="bg-indigo-900 shadow-lg text-white py-4 mb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-xl font-bold text-center tracking-wider">Сервіс Криптографії (RSA)</h1>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4">

    {% if message or error %}
    <div class="mb-6 p-4 rounded-lg text-sm {% if error %}bg-red-100 text-red-800 border border-red-300{% else %}bg-green-100 text-green-800 border border-green-300{% endif %}" role="alert">
        {{ message | default:error }}
    </div>
    {% endif %}

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">1. Генерація RSA Ключів</h2>
        <form method="post" action="." class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="generate_keys">
            <p class="text-gray-600">Натисніть кнопку, щоб згенерувати нову пару публічного та приватного ключів.</p>
            <button type="submit" class="btn-primary">
                Генерувати нові ключі
            </button>
        </form>

        {% if private_key and public_key %}
        <div class="mt-6 space-y-4">
            <div>
                <label class="block text-gray-700 font-medium mb-1">Приватний ключ (Private Key):</label>
                <div class="key-output h-32 overflow-auto">{{ private_key }}</div>
                <a href="#" id="download-private" class="btn-secondary mt-2 inline-block text-sm" download="private_key.pem">Завантажити Private Key</a>
            </div>
            <div>
                <label class="block text-gray-700 font-medium mb-1">Публічний ключ (Public Key):</label>
                <div class="key-output h-32 overflow-auto">{{ public_key }}</div>
                <a href="#" id="download-public" class="btn-secondary mt-2 inline-block text-sm" download="public_key.pem">Завантажити Public Key</a>
            </div>
        </div>
        {% endif %}

    </section>

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">2. Шифрування Файлу RSA</h2>

        <form method="post" action="." enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="encrypt_rsa">
            <p class="text-gray-600">Виберіть файл для шифрування та файл публічного ключа (.pem). Зашифрований файл буде завантажено.</p>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Файл для шифрування:</label>
                <input type="file" name="data_file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Файл публічного ключа (.pem):</label>
                <input type="file" name="public_key_file" accept=".pem" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" required>
            </div>

            <button type="submit" class="btn-primary">
                Зашифрувати файл (RSA)
            </button>
        </form>

        {% if encrypted_data_base64 and cipher_type == "RSA" %}
        <div class="result-box">
            <h3 class="font-bold text-lg text-gray-800 mb-2">Результати шифрування RSA:</h3>
            <p><strong>Час виконання:</strong> <span class="text-blue-600">{{ enc_time }} сек.</span></p>
            <button onclick="downloadFile('{{ encrypted_data_base64 }}', '{{ encrypted_filename }}')"
                    class="btn-primary mt-4 w-full bg-green-700 hover:bg-green-800 transition duration-200">
                Завантажити Зашифрований Файл ({{ encrypted_filename }})
            </button>
        </div>
        {% endif %}
    </section>

    <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
        <h2 class="card-title">3. Розшифрування Файлу RSA</h2>

        <form method="post" action="." enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="decrypt_rsa">

            <p class="text-gray-600">Виберіть зашифрований файл (.rsa) та **приватний ключ** (.pem) для його розшифрування.</p>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Зашифрований файл (.rsa):</label>
                <input type="file" name="encrypted_file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Файл приватного ключа (.pem):</label>
                <input type="file" name="private_key_file" accept=".pem" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" required>
            </div>

            <button type="submit" class="btn-primary">
                Розшифрувати файл (RSA)
            </button>
        </form>

        {% if decrypted_data_base64 and cipher_type == "RSA" %}
        <div class="result-box">
            <h3 class="font-bold text-lg text-gray-800 mb-2">Результати розшифрування RSA:</h3>
            <button onclick="downloadFile('{{ decrypted_data_base64 }}', '{{ decrypted_filename }}')"
                    class="btn-primary mt-4 w-full bg-red-700 hover:bg-red-800 transition duration-200">
                Завантажити Розшифрований Файл ({{ decrypted_filename }})
            </button>
        </div>
        {% endif %}
    </section>

</main>

<script>
    /**
     * Функція для завантаження файлу з Base64 рядка.
     * @param {string} base64Data - Base64 закодовані бінарні дані.
     * @param {string} filename - Ім'я файлу для завантаження.
     */
    function downloadFile(base64Data, filename) {
        if (!base64Data || !filename) {
            console.error("Missing data or filename for download.");
            return;
        }
        try {
            // 1. Декодування Base64 у бінарний рядок
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);

            // 2. Перетворення бінарного рядка на масив байтів
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // 3. Створення Blob (двійкового об'єкта)
            const blob = new Blob([bytes], { type: 'application/octet-stream' });

            // 4. Створення посилання для завантаження
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;

            // 5. Запуск завантаження
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Звільнення об'єкта
        } catch (e) {
            alert(`Помилка завантаження файлу: ${e.message}. Перевірте, чи коректні Base64 дані.`);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const privateKeyLink = document.getElementById('download-private');
        const publicKeyLink = document.getElementById('download-public');

        if (privateKeyLink && publicKeyLink) {
            // Отримуємо вміст ключа з попереднього елемента div.key-output
            const privateContent = privateKeyLink.previousElementSibling.innerText;
            const publicContent = publicKeyLink.previousElementSibling.innerText;

            function createDownloadLink(element, content) {
                const blob = new Blob([content], { type: 'application/x-pem-file' });
                const url = URL.createObjectURL(blob);
                element.href = url;
            }

            // Прив'язка до посилань для завантаження ключів (якщо вони були згенеровані)
            createDownloadLink(privateKeyLink, privateContent);
            createDownloadLink(publicKeyLink, publicContent);
        }
    });
</script>

</body>
</html>